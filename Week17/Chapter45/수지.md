# 45.1 비동기 처리를 위한 콜백 패턴의 단점

## **45.1.1 콜백 지옥**

- 비동기 함수 내부의 비동기 코드로 동작하는 코드는 비동기 함수가 종료된 이후에 완료됨
- 비동기 함수는 비동기 처리 결과를 외부에 반환할 수 없고, 상위 스코프의 변수에 할당할 수도 없음
  - 비동기 함수의 처리 결과에 대한 후속 처리는 비동기 함수 내부에서 수행해야 함
  - 성공/실패 시 실행시킬 콜백 함수를 전달하는 게 일반적
    - 콜백 지옥 발생
      - 가독성 나쁨
      - 실수를 유발하는 원인이 됨

## **45.1.2 에러 처리의 한계**

- try...catch...finally 구문으로 비동기 코드 에러는 잡아낼 수 없다

# 45.2 프로미스의 생성

**Promise 생성자 함수**

- Promise 객체 생성
- 비동기 처리를 수행할 콜백 함수를 인수로 전달 받음
- 콜백함수는 resolve, reject 함수를 인수로 전달 받음

**프로미스의 상태 정보**

- resolve 또는 reject 함수를 호출하는 것으로 결정됨
  - pending : 프로미스가 생성된 직후 기본 상태 ( <-> settled)
  - fulfilled : resolve 함수 호출 시
  - rejected: reject 함수 호출 시

**프로미스 : 비동기 처리 상태와 처리 결과를 관리하는 객체**

# 45.3 프로미스의 후속 처리 메서드

- **프로미스의 비동기 처리 상태가 변화하면,  후속 처리 메서드에 인수로 전달한 콜백 함수가 선택적으로 호출됨**
- 모든 후속 처리 메서드는 프로미스를 반환 & 비동기로 동작
  - 콜백 함수가 프로미스가 아닌 값을 반환하면, 그 값을 암묵적으로 resolve 또는 reject하여 프로미스를 생성해 반환함
- then, catch, finally

# 45.4 프로미스의 에러 처리

- 비동기 처리 결과에 대한 후속 처리는 프로미스가 제공하는 후속 처리 메서드를 사용하여 수행
- 비동기 처리에서 발생한 에러
  - then 메서드의 두 번째 콜백 함수로 처리할 수 있음
    - 첫 번째 콜백 함수에서 발생한 에러를 캐치하지 못함
    - 코드가 복잡해져 가독성 나쁨
  - **catch 메서드를 사용해서도 처리할 수 있음 (권장)**
    - 내부적으로 then(undefined, onRejected) 호출
    - 비동기 처리 에러 뿐만 아니라 then 메서드 내부 에러도 캐치 가능
    - 가독성 좋음

# 45.5 프로미스 체이닝

- then, catch, finally 후속 처리 메서드를 연속적으로 호출
- 후속 처리 메서드의 콜백 함수는 프로미스의 비동기 처리 상태가 변경되면 선택적으로 호출됨
- 프로미스는 프로미스 체이닝을 통해 비동기 처리 결과를 전달받아 후속 처리 함
  - 비동기 처리를 위한 콜백 패턴에서 콜백 헬 발생하지 않음
  - 콜백 패턴은 여전히 사용함 (가독성 나쁨) -> async/await으로 해결 가능

# 45.6 프로미스의 정적 메서드

1. **resolve, reject**
   - 이미 존재하는 값을 래핑하여 프로미스 생성
2. **all**
   - 여러 개의 비동기 처리를 모두 병렬 처리할 때 사용
   - 프로미스를 요소로 갖는 배열 등의 이터러블을 인수로 전달 받음
   - 전달받은 모든 프로미스가 모두 fulfilled 상태가 되면 종료
   - 소요 시간은 가장 늦게 fulfilled 상태가 되는 프로미스의 처리 시간보다 조금 더 김
   - 처리 순서 보장
   - 하나라도 reject되면 나머지 프로미스 기다리지 않고 바로 종료
3. **race**
   - all과 유사
   - 모든 프로미스의 fulfilled 기다리지 않고, 가장 먼저 fulfilled된 프로미스의 처리 결과를 resolve하는 새로운 프로미스 반환
   - 하나라도 rejected되면, 에러를 reject하는 새로운 프로미스 즉시 반환
4. **allSettled**
   - 전달받은 프로미스가 모두 settled 상태가 되면 처리 결과를 배열로 반환

# 45.7 마이크로태스크 큐

**마이크로태스크 큐**

- 프로미스의 후속 처리 메서드의 콜백 함수가 일시 저장됨
- 태스크 큐와는 별도의 큐
- 태스크 큐보다 우선순위 높음

**태스크 큐 (매크로태스크 큐)**

- 비동기 함수의 콜백 함수, 이벤트 핸들러가 일시 저장됨

**이벤트 루프**

- 콜스택이 비면, 1) 마이크로태스크 큐 대기 함수 가져옴 2) 매크로태스크 큐 대기 함수 가져옴

# 45.8 fetch

**fetch**

- HTTP 요청 전송 기능을 제공하는 클라이언트 사이드 Web API
- HTTP 응답을 나타내는 Response 객체를 래핑한 Promise 객체를 반환함

**에러**

- HTTP 에러가 발생해도 에러를 reject하지 않고 불리언 타입의 ok 상태를 false로 설정한 Response 객체를 resolve함
- 오프라인 등의 네트워크 장애나 CORS 에러 때만 프로미스 reject
  - 명시적인 에러 처리 필요

**axios**

- 모든 HTTP 에러를 reject하는 프로미스 반환
  - 모든 에러 캐치 가능해 편리함
  - 인터셉터, 요청 설정 등 다양한 기능 지원
