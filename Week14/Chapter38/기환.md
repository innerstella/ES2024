# 38장 브라우저의 렌더링 과정

**파싱**
- 파싱은 프로그래밍 언어의 문법에 맞게 작성된 텍스트 문서를 읽어 들여 실행하기 위해 텍스트 문서의 문자열을 토큰으로 분해하고, 토큰에 문법적 의미와 구조를 반영하여 트리 구조의 자료구조인 파스 트리를 - 생성하는 일련의 과정을 말한다. 일반적으로 파싱이 완료된 이후에는 파스 트리를 기반으로 중간언어인 바이트코드를 생성하고 실행한다.
**렌더링**
- 렌더링은 HTML, CSS, 자바스크립트로 작성된 문서를 파싱하여 브라우저에 시각적으로 출력하는 것을 말한다.

**렌더링 과정**
- 브라우저는 HTML, CSS 자바스크립트, 이미지, 폰트 파일 등 렌더링에 필요한 리소스를 요청하고 서버로부터 응답을 받는다.
- 브라우저의 렌덜이 ㅇ엔진은 서버로부터 응답된 HTML과 CSS를 파싱하여 DOM과 CSSOM을 생성하고 이들을 결합하여 렌더 트리를 생성한다.
- 브라우저의 자바스크립트 엔진은 서버로부터 응답된 자바스크립트를 파싱하여 AST를 생성하고 바이트코드로 변환하여 실행한다. 이때 자바스크립트는 DOM API를 통해 DOM이나 CSSOM을 변경할 수 있다. 변경된 - DOM과 CSSOM은 다시 렌더 트리로 결합된다.
- 렌더 트리를 기반으로 HTML 요소의 레이아웃을 계산하고 브라우저 화면에 HTML요소를 페인팅한다.

## 38.1 요청과 응답
- 브라우저의 핵심 기능은 필요한 리소스를 서버에 요청 및 응답을 통해 브라우저에 시각적으로 렌더링 하는 것
- 주소창에 입력된 URL의 호스트이름이 DNS를 통해 IP 주소로 변환되고 이 IP 주소를 갖는 서버에게 요청을 전송
- 루트 요청에 대해 암묵적으로 index.html을 응답한다.
- 다른 정적 파일을 서버에 요청하려면 정적 파일의 경로와 파일이름을 path에 기술하여 요청

## 38.2 HTTP 1.1과 HTTP 2.0
- HTTP는 웹에서 브라우저와 서버가 통신하기 위한 프로토콜
- 1.1은 기본적으로 커넥션당 하나의 요청과 응답만 처리
- 여러 리소스 요청이 개별적으로 전송되고, 응답 또한 개별적으로 전송됨
- 동시 전송이 불가능하므로 리소스 개수에 비례하여 응답시간도 증가하는 단점이 있음
- 2.0부터는 커넥션당 여러 개의 요청과 응답이 가능하다.

## 38.3 HTML 파싱과 DOM 생성
- 브라우저의 요청에 의해 서버가 응답한 HTML 문서는 문자열로 이루어진 순수한 텍스트
- 순수한 텍스트를 렌더링하기 위해 HTML문서를 파싱하여 브라우저가 이해할 수 있는 자료구조인 DOM을 생성
=> **DOM은 HTML 문서를 파싱한 결과물**

## 38.4 CSS 파싱과 CSSOM 생성
- 렌더링 엔진은 HTML을 한 줄씩 파싱하여 DOM을 생성해 나감
- DOM을 생성해 나가다가 CSS를 로드할 때 DOM 생성을 일시 중단
- CSS를 HTML과 동일 파싱 과정을 거치며 해석 후, CSSOM 생성
- CSS 파싱을 완료하면 HTML 파싱이 중단된 지점부터 다시 파싱하기 시작하며 DOM 생성

## 38.5 렌더 트리 생성
- 생성된 DOM과 CSSOM은 렌더링을 위해 렌더 트리로 결합됨
- 렌더 트리는 렌더링을 위한 트리 구조의 자료구조
- 화면에 렌더링 되지 않는 노드와 CSS에 비표시되는 노드들은 비포함

## 38.6 자바스크립트 파싱과 실행
- DOM은 DOM API를 제공하여 생성된 DOM을 동적으로 조작할 수 있다.
- 렌더링 엔진은 DOM 생성 중 script 태그를 만나면 DOM 생성을 중단, 자바스크립트 엔진에 제어권을 넘겨 script 태그 내의 코드를 파싱한다.
- 자바스크립트 파싱이 끝나면 렌더링 엔진에 제어권을 다시 넘겨 DOM 생성을 재개함
- 자바스크립트 엔진은 자바스크립트를 해석하여 AST(추상적 구문 트리)를 생성

## 38.7 리플로우와 리페인트
- 자바스크립트 코드에 DOM이나 CSSOM을 변경이 된다면 변경된 DOM과 CSSOM은 다시 렌더 트리로 결합됨
- 변경된 렌더트리를 기반으로 레이아웃과 페인트 과정을 거쳐 리렌더링함
  - **리플로우** : 레이아웃 계싼을 다시 하는 것
  - **리페인트** : 재결합된 렌더 트리를 기반으로 다시 페인트를 하는 것

## 38.8 자바스크립트 파싱에 의한 HTML 파싱 중단
- 렌더링 엔진과 자바스크립트 엔진은 직렬적으로 파싱을 수행
- script 태그의 위치에 따라 DOM 생성이 지연될 수 있으므로 script 태그의 위치는 중요한 의미를 가짐
- body 요소의 가장 아래에 자바스크립트를 위치하는 것은 좋은 아이디어
- DOM이 완성되지 않은 상태에서 자바스크립트가 DOM을 조작하면 에러가 발생할 수 잇음
- 자바스크립트 로딩/파싱/실행으로 인해 HTML 요소들의 렌더링에 지장받는 일이 발생하지 않아 페이지 로딩 시간이 단축됨


## 38.9 script 태그의 async/defer 어트리뷰트
- 자바스크립트 파싱에 의한 DOM 생성 중단 문제를 해결하기 위해 async 과 defer 어트리뷰트가 추가됨
- src 어트리뷰트를 통해 외부 자바스크립트 파일을 로드하는 경우에만 사용할 수 있음
- async와 defer 어트리뷰트를 사용하면 HTML 파싱과 외부 자바스크립트 파일의 로드가 비동기적으로 동시에 진행됨
  - **async 어트리뷰트**
    - HTML 파싱과 외부 자바스크립트 파일의 로드가 비동기적으로 동시에 진행
    - 자바스크립트 파싱/실행은 자바스크립트 파일의 로드가 완료된 직후 진행되며, HTML 파싱이 중단됨
    - 순서가 보장되지 않으므로 순서 보장이 필요한 경우에는 sync 어트리뷰트를 지정하지 않아야함
  - **defer 어트리뷰트**
    - HTML 파싱과 외부 자바스크립트 파일의 로드가 비동기적으로 동시에 진행
    - 자바스크립트 파싱/실행은 HTML 파싱이 완료된 직후(DOM 생성 완료)에 진행됨
    - DOM 생성이 완료된 이후 실행되어야할 자바스크립트에 유용
